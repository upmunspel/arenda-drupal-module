/**
 * @license MIT
 * @license http://opensource.org/licenses/MIT Massachusetts Institute of Technology
 * @copyright 2014 Patric Gutersohn
 * @author Patric Gutersohn
 * @example index.html BDT in action.
 * @link http://bdt.gutersohn.biz Documentation
 * @version 1.0.0
 *
 * @summary BDT - Bootstrap Data Tables
 * @description sorting, paginating and search for bootstrap tables
 */
(function(e) {
    "use strict";
    var t = 1;
    var n = 0;
    var r = 0;
    var i = "";
	var ii = "";
    var s = null;
    var o = false;
    var u = "";
    var a = "";
    e.fn.bdt = function(f, l) {
        function p(t) {
            var n = t;
            var r = 0;
            t.find("thead th").wrapInner('<span class="sort-element"/>').append(e("<span/>").addClass("sort-icon fa")).each(function() {
                var i = e(this);
                var s = i.index();
                var o = false;
                var f = true;
                i.click(function() {
                    if (e(this).find(".sort-icon").hasClass(a)) {
                        e(this).find(".sort-icon").removeClass(a).addClass(u)
                    } else {
                        e(this).find(".sort-icon").removeClass(u).addClass(a)
                    }
                    if (r != s) {
                        t.find(".sort-icon").removeClass(a);
                        t.find(".sort-icon").removeClass(u);
                        e(this).find(".sort-icon").toggleClass(a, f)
                    }
                    n.find("td").filter(function() {
                        return e(this).index() === s
                    }).sortElements(function(t, n) {
                        return e.text([t]) > e.text([n]) ? o ? -1 : 1 : o ? 1 : -1
                    }, function() {
                        return this.parentNode
                    });
                    o = !o;
                    r = s
                })
            })
        }
        function d() {
            e("#table-nav-top").remove();
            e("#table-nav-bottom").remove();
            i = e("<ul/>");
			ii = e("<ul/>");
            e.each(new Array(n), function(t) {
                var n = "";
                var r = e();
                if (t + 1 == 1) {
                    n = "active"
                }
                i.append(e("<li/>").addClass(n).data("page", t + 1).append(e("<a/>").text(t + 1)));
				ii.append(e("<li/>").addClass(n).data("page", t + 1).append(e("<a/>").text(t + 1)));
            });
            e("#bottom-paginator").append(e("<nav/>").addClass("pagination").attr("id", "table-nav-bottom").append(i.addClass("pull-left").prepend(e("<li/>").addClass("disabled").data("page", "previous").append(e('<a href="#" />').append(e("<span/>").attr("aria-hidden", "true").html("&laquo;")).append(e("<span/>").addClass("sr-only").text("Назад")))).append(e("<li/>").addClass("disabled").data("page", "next").append(e('<a href="#" />').append(e("<span/>").attr("aria-hidden", "true").html("&raquo;")).append(e("<span/>").addClass("sr-only").text("Далее"))))));
               e("#top-paginator").append(e("<nav/>").addClass("pagination").attr("id", "table-nav-top").append(ii.addClass("pull-left").prepend(e("<li/>").addClass("disabled").data("page", "previous").append(e('<a href="#" />').append(e("<span/>").attr("aria-hidden", "true").html("&laquo;")).append(e("<span/>").addClass("sr-only").text("Назад")))).append(e("<li/>").addClass("disabled").data("page", "next").append(e('<a href="#" />').append(e("<span/>").attr("aria-hidden", "true").html("&raquo;")).append(e("<span/>").addClass("sr-only").text("Далее"))))));

        }
        function v(t) {
            e("#search").on("keyup", function() {
                e.each(t.find("tr"), function() {
                    var t = e(this).text().replace(/ /g, "").replace(/(\r\n|\n|\r)/gm, "");
                    var n = e("#search").val();
                    if (t.toLowerCase().indexOf(n.toLowerCase()) == -1) {
                        e(this).hide().removeClass("search-item")
                    } else {
                        e(this).show().addClass("search-item")
                    }
                    if (n != "") {
                        o = true
                    } else {
                        o = false
                    }
                });
                m(t);
                d();
                g(t, 1)
            });
			e("#f_btn").on("click", function() {
				$('#f_form').trigger( 'reset' );
				e("#f_start").trigger('change');

			});
			e("#f_start, #f_end").on("change", function() {
				var fstart = e("#f_start").val();
				var fend = e("#f_end").val();
				if (e(this).attr("id") == "f_start" && ( fend < fstart || fend == "") ){
					e("#f_end").attr("min",fstart);
					e("#f_end").val(fstart);
					fend  = fstart;
				}
				
				e.each(t.find("tr"), function() {
					var is_show = false;
					var  day_count = 0;
					var  show_count = 0;
					e(this).find(".day").each( function(){
						e(this).removeClass("selected")
						if (fstart != "" && fend == ""){
							if (e(this).data("date") == fstart && e(this).hasClass("not-reserved")){
								is_show = true;
							}
						} 
						if (fend != "" && fstart == ""){
							if (e(this).data("date") == fend && e(this).hasClass("not-reserved")){
								is_show = true;
							}
						} 
						if (fend != "" && fstart != ""){
							var date = e(this).data("date");
							if ((date >= fstart && date <= fend) ){
								day_count++;
								
								if (e(this).hasClass("not-reserved")){
									is_show = true;
									show_count++; 
									e(this).addClass("selected")
								}
								if (date == fstart && e(this).hasClass("end")){
									is_show = true;
									show_count++; 
									e(this).addClass("selected")
								}
								if (date == fend && e(this).hasClass("start")){
									is_show = true;
									show_count++; 
									e(this).addClass("selected")
								}
							} 
						}
					 
					});
					if (fend != "" && fstart != ""){
						if (day_count == show_count){
							is_show = true;
						} else {
							
							is_show = false;
						}
							
					} 
					if (!is_show){
                        e(this).hide().removeClass("search-item")
                    } else {
                        e(this).show().addClass("search-item")
                    }
                    if (fstart != "") {
                        o = true
                    } else {
                        o = false
                    }
                });
                m(t);
                d();
                g(t, 1)
            })
			
			 /*e("#f_end").on("change", function() {
				alert();
                e.each(t.find("tr"), function() {
                    var t = e(this).text().replace(/ /g, "").replace(/(\r\n|\n|\r)/gm, "");
                    var n = e("#search").val();
                    if (t.toLowerCase().indexOf(n.toLowerCase()) == -1) {
                        e(this).hide().removeClass("search-item")
                    } else {
                        e(this).show().addClass("search-item")
                    }
                    if (n != "") {
                        o = true
                    } else {
                        o = false
                    }
                });
                m(t);
                d();
                g(t, 1)
            })*/
        }
        function m(e) {
            if (o) {
                n = Math.round(e.children(".search-item").length / r)
            } else {
                n = Math.round(e.children("tr").length / r)
            }
            if (n == 0) {
                n = 1
            }
        }
        function g(i, s) {
            if (s == "next") {
                s = t + 1
            } else if (s == "previous") {
                s = t - 1
            }
            t = s;
            var u = o ? i.find(".search-item") : i.find("tr");
            var a = r * s;
            var f = a - r;
            var l = e(".pagination");
            u.hide();
            u.slice(f, a).show();
            l.find("li").removeClass("active disabled");
            l.find("li:eq(" + s + ")").addClass("active");
            if (s == 1) {
                l.find("li:first").addClass("disabled")
            } else if (s == n) {
                l.find("li:last").addClass("disabled")
            }
        }
        var c = e.extend({pageRowCount: 800, arrowDown: "fa-angle-down", arrowUp: "fa-angle-up"}, f);
        var h = null;
        return this.each(function() {
            s = e(this).addClass("bdt");
            h = s.find("tbody");
            r = c.pageRowCount;
            a = c.arrowDown;
            u = c.arrowUp;
            s.before(e("<div/>").addClass("row-fluid").append(e('<div/>').addClass("span9").attr('id','top-paginator')).append(
                                        e("<div/>").addClass('span3').append(
                                            e("<form/>").addClass("pull-right").attr("role", "form").append(e("<div/>").addClass("form-group").append(e("<input/>").addClass("form-control").attr('type','text').attr("id", "search").attr("placeholder", "Поиск...")))
                                        ))
                    );
            s.after(e("<div/>").addClass("row-fluid").append(e('<div/>').addClass("span9").attr('id','bottom-paginator')).append(
                    e("<div/>").attr("id", "table-footer").append(e("<div/>").addClass("span3").append(e("<form/>").addClass("form-horizontal  pull-right").attr("id", "page-rows-form").append(e("<label/>").addClass("control-label").text("Кол-во строк:")).append(e("<div/>").addClass("pull-left").append(e("<select/>").addClass("form-control row-count").append(e("<option>", {value: 5, text: 5})).append(e("<option>", {value: 10, text: 10})).append(e("<option>", {value: 15, text: 15})).append(e("<option>", {value: 20, text: 20})).append(e("<option>", {value: 25, text: 25})).append(e("<option>", {value: 100, text: 100})).append(e("<option>", {value: 200, text: 200})).append(e("<option>", {value: 400, text: 400})).append(e("<option>", {value: 800, text: 800, selected: "selected"})))))
                    ))
                    );
            if (h.children("tr").length > r) {
                m(h);
                d();
                g(h, t)
            }
            v(h);
            p(s, h);
            e("body").on("click", ".pagination li", function(t) {
                var n;
                if (e(t.target).is("a")) {
                    n = e(t.target).parent()
                } else {
                    n = e(t.target).parent().parent()
                }
                var r = n.data("page");
                if (!n.hasClass("disabled") && !n.hasClass("active")) {
                    g(h, r)
                }
            });
            e("#page-rows-form").on("change", function() {
                var t = e(this).find("select");
                r = t.val();
                m(h);
                d();
                g(h, 1)
            })
        })
    }
})(jQuery)

